// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.
//>>built
require({cache:{"esri/tasks/Task":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/has ../kernel ../deferredUtils ../urlUtils ../Evented".split(" "),function(f,n,r,s,p,e,u,k){f=f(k,{declaredClass:"esri.tasks._Task",_eventMap:{error:["error"],complete:["result"]},constructor:function(c,d){c&&n.isString(c)&&(this._url=u.urlToObject(this.url=c));d&&d.requestOptions&&(this.requestOptions=d.requestOptions);this.normalization=!0;this._errorHandler=n.hitch(this,this._errorHandler);
this.registerConnectEvents()},_useSSL:function(){var c=this._url,d=/^http:/i;this.url&&(this.url=this.url.replace(d,"https:"));c&&c.path&&(c.path=c.path.replace(d,"https:"))},_encode:function(c,d,b){var a,g,m={},t,l;for(t in c)if("declaredClass"!==t&&(a=c[t],g=typeof a,null!==a&&void 0!==a&&"function"!==g))if(n.isArray(a)){m[t]=[];l=a.length;for(g=0;g<l;g++)m[t][g]=this._encode(a[g])}else"object"===g?a.toJson&&(g=a.toJson(b&&b[t]),"esri.tasks.FeatureSet"===a.declaredClass&&g.spatialReference&&(g.sr=
g.spatialReference,delete g.spatialReference),m[t]=d?g:r.toJson(g)):m[t]=a;return m},_successHandler:function(c,d,b,a){d&&this[d].apply(this,c);b&&b.apply(null,c);a&&e._resDfd(a,c)},_errorHandler:function(c,d,b){this.onError(c);d&&d(c);b&&b.errback(c)},setNormalization:function(c){this.normalization=c},onError:function(){}});s("extend-esri")&&(p.Task=f);return f})},"esri/layers/RenderMode":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/io/script ../kernel".split(" "),
function(f,n,r,s,p,e,u){n=n(null,{declaredClass:"esri.layers._RenderMode",constructor:function(){this._prefix="jsonp_"+(f._scopeName||"dojo")+"IoScript"},initialize:function(k){this.map=k;this._init=!0},startup:function(){},propertyChangeHandler:function(k){},destroy:function(){this._init=!1},drawFeature:function(k){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(k){(k=this._featureMap[k])&&k._count++},_decRefCount:function(k){(k=this._featureMap[k])&&k._count--},
_getFeature:function(k){return this._featureMap[k]},_addFeatureIIf:function(k,c){var d=this._featureMap,b=d[k],a=this.featureLayer;b||(d[k]=c,a._add(c),c._count=0);return b||c},_removeFeatureIIf:function(k){var c=this._featureMap[k],d=this.featureLayer;if(c){if(c._count)return;delete this._featureMap[k];d._remove(c)}return c},_clearIIf:function(){var k;k=this.featureLayer;var c=k.graphics,d=k._selectedFeatures,b=k.objectIdField;for(k=c.length-1;0<=k;k--){var a=c[k],g=a.attributes[b];g in d?a._count=
1:(a._count=0,this._removeFeatureIIf(g))}},_isPending:function(k){return e[this._prefix+k]?!0:!1},_cancelPendingRequest:function(k,c){if(k=k||e[this._prefix+c])try{k.cancel(),e._validCheck(k)}catch(d){}},_purgeRequests:function(){e._validCheck(null)},_toggleVisibility:function(k){var c=this.featureLayer,d=c.graphics,b=k?"show":"hide",a,g=d.length;k=k&&c._ager;for(a=0;a<g;a++){var m=d[a];m[b]();k&&c._repaint(m)}},_applyTimeFilter:function(k){var c=this.featureLayer;if(c.timeInfo&&!c.suspended){k||
c._fireUpdateStart();var d=c._trackManager;d&&d.clearTracks();var b=c.getTimeDefinition(),a=c._getOffsettedTE(c._mapTimeExtent);a?(a=c._getTimeOverlap(b,a))?(b=c._filterByTime(c.graphics,a.startTime,a.endTime),d&&d.addFeatures(b.match),s.forEach(b.match,function(a){var b=a._shape;a.visible||(a.show(),(b=a._shape)&&b._moveToFront());c._ager&&b&&c._repaint(a)}),s.forEach(b.noMatch,function(a){a.visible&&a.hide()})):this._toggleVisibility(!1):(d&&d.addFeatures(c.graphics),this._toggleVisibility(!0));
d&&(d.moveLatestToFront(),d.drawTracks());k||c._fireUpdateEnd()}}});p("extend-esri")&&r.setObject("layers._RenderMode",n,u);return n})},"esri/tasks/FeatureSet":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../graphic ../SpatialReference ../graphicsUtils ../geometry/jsonUtils ../symbols/jsonUtils".split(" "),function(f,n,r,s,p,e,u,k,c,d,b){f=f(null,{declaredClass:"esri.tasks.FeatureSet",constructor:function(a){if(a){n.mixin(this,a);var g=this.features,
m=a.spatialReference,c=d.getGeometryType(a.geometryType),m=this.spatialReference=new k(m);this.geometryType=a.geometryType;a.fields&&(this.fields=a.fields);r.forEach(g,function(a,h){var q=a.geometry&&a.geometry.spatialReference;g[h]=new u(c&&a.geometry?new c(a.geometry):null,a.symbol&&b.fromJson(a.symbol),a.attributes);g[h].geometry&&!q&&g[h].geometry.setSpatialReference(m)});this._hydrate()}else this.features=[]},displayFieldName:null,geometryType:null,spatialReference:null,fieldAliases:null,toJson:function(a){var b=
{};this.displayFieldName&&(b.displayFieldName=this.displayFieldName);this.fields&&(b.fields=this.fields);this.spatialReference?b.spatialReference=this.spatialReference.toJson():this.features[0]&&this.features[0].geometry&&(b.spatialReference=this.features[0].geometry.spatialReference.toJson());this.features[0]&&(this.features[0].geometry&&(b.geometryType=d.getJsonType(this.features[0].geometry)),b.features=c._encodeGraphics(this.features,a));b.exceededTransferLimit=this.exceededTransferLimit;b.transform=
this.transform;return e.fixJson(b)},_hydrate:function(){var a=this.transform,b=this.geometryType;if(a&&b)for(var m=this.features,c=a.translate[0],l=a.translate[1],h=a.scale[0],q=a.scale[1],d=function(a,b,h){if("esriGeometryPoint"===a)return function(a){a.x=b(a.x);a.y=h(a.y)};if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a)return function(a){a=a.rings||a.paths;var l,g,m,c,q,d,t,v;l=0;for(g=a.length;l<g;l++){q=a[l];m=0;for(c=q.length;m<c;m++)d=q[m],0<m?(t+=d[0],v+=d[1]):(t=d[0],v=d[1]),d[0]=
b(t),d[1]=h(v)}};if("esriGeometryEnvelope"===a)return function(a){a.xmin=b(a.xmin);a.ymin=h(a.ymin);a.xmax=b(a.xmax);a.ymax=h(a.ymax)};if("esriGeometryMultipoint"===a)return function(a){a=a.points;var l,g,m,c,q;l=0;for(g=a.length;l<g;l++)m=a[l],0<l?(c+=m[0],q+=m[1]):(c=m[0],q=m[1]),m[0]=b(c),m[1]=h(q)}}(b,function(a){return a*h+c},function(a){return l-a*q}),a=0,b=m.length;a<b;a++)m[a].geometry&&d(m[a].geometry);this.transform=null},quantize:function(a){if(!this.geometryType)return this.transform=
null,this;var b=a.translate[0],m=a.translate[1],c=a.scale[0],l=a.scale[1],h=this.features,q=function(a,b,h){var l,g,m,c,q,d,t=[];l=0;for(g=a.length;l<g;l++)if(m=a[l],0<l){if(d=b(m[0]),m=h(m[1]),d!==c||m!==q)t.push([d-c,m-q]),c=d,q=m}else c=b(m[0]),q=h(m[1]),t.push([c,q]);return 0<t.length?t:null},d=function(a,b,l){if("esriGeometryPoint"===a)return function(a){a.x=b(a.x);a.y=l(a.y);return a};if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a)return function(a){var h,m,g,c,d;g=a.rings||a.paths;
d=[];h=0;for(m=g.length;h<m;h++)c=g[h],(c=q(c,b,l))&&d.push(c);return 0<d.length?(a.rings?a.rings=d:a.paths=d,a):null};if("esriGeometryMultipoint"===a)return function(a){var h;h=q(a.points,b,l);return 0<h.length?(a.points=h,a):null};if("esriGeometryEnvelope"===a)return function(a){return a}}(this.geometryType,function(a){return Math.round((a-b)/c)},function(a){return Math.round((m-a)/l)}),k,e;k=0;for(e=h.length;k<e;k++)h[k].geometry&&(d(h[k].geometry)||h[k].setGeometry(null));this.transform=a;return this}});
s("extend-esri")&&n.setObject("tasks.FeatureSet",f,p);return f})},"esri/layers/StreamMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../tasks/query ../tasks/QueryTask ../geometry/jsonUtils ./RenderMode".split(" "),function(f,n,r,s,p,e,u,k,c,d){f=f([d],{declaredClass:"esri.layers._StreamMode",constructor:function(b,a){this.featureLayer=b;this._featureMap={};this._setRefreshRate();this._drawBuffer={adds:[],updates:[]};this._timeoutId=
null;this._flushDrawBuffer=n.hitch(this,this._flushDrawBuffer);this._featuresByTime={};this._lastEndTimeCheck=null;this._maxFeatureAge=0;b.purgeOptions&&(b.purgeOptions.age&&"number"===typeof b.purgeOptions.age)&&(this._maxFeatureAge=1E3*Math.ceil(60*b.purgeOptions.age));this._drawFeatures=n.hitch(this,this._drawFeatures);this._queryErrorHandler=n.hitch(this,this._queryErrorHandler)},startup:function(){},propertyChangeHandler:function(b){this._init&&(0===b?this._applyTimeFilter():3===b?this._redrawAllTracks():
console.debug("StreamLayer: Stream Layer only supports changing map time or maximumTrackPoints. Layer id \x3d "+this.featureLayer.id))},drawFeature:function(b){var a=this.featureLayer,g=a.objectIdField;this._timeoutId||(this._timeoutId=setTimeout(this._flushDrawBuffer,this._refreshRate));a._joinField&&this._getFeature(b.attributes[g])?this._drawBuffer.updates.push({oid:b.attributes[g],updates:b}):this._drawBuffer.adds.push(b)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var b=
this.featureLayer;b&&(!b._relatedUrl&&!b._keepLatestUrl?(b._fireUpdateStart(),b.clear(),b._fireUpdateEnd()):(b._fireUpdateStart(),b._refreshing=!0,b.disconnect(),b.clear(),b._relatedQueried=!1,b._keepLatestQueried=!1,b.connect()))},_drawFeatures:function(b,a){this._purgeRequests();var g=this.featureLayer;g._create(b.features||[]);g._fireUpdateEnd(null,a)},_applyTimeFilter:function(b){this.inherited(arguments);this._redrawAllTracks()},_removeFeatures:function(b){var a=this.featureLayer,g=a.objectIdField;
b&&r.forEach(b,function(b){b=b.attributes[g];a._unSelectFeatureIIf(b,this);this._decRefCount(b);this._removeFeatureIIf(b)},this)},_addFeatures:function(b){var a=this.featureLayer,g=a._endTimeField,m=a._startTimeField,c,l,h,q=[],d=[],k=[];c=a._trackManager;l=a.objectIdField;if(c)for(h in b=c.addFeatures(b),b)b.hasOwnProperty(h)&&(q.push(h),b[h].adds&&(d=d.concat(b[h].adds)),b[h].deletes&&(k=k.concat(b[h].deletes)));else d=b;r.forEach(d,function(a){var b=a.attributes[l],h;h=g&&a.attributes[g];!h&&this._maxFeatureAge&&
(h=m&&a.attributes[m]?a.attributes[m]+this._maxFeatureAge:Date.now()+this._maxFeatureAge);h&&(h=1E3*Math.ceil(h/1E3),this._featuresByTime[h]?this._featuresByTime[h].push(b):this._featuresByTime[h]=[b]);this._addFeatureIIf(b,a);this._incRefCount(b)},this);k.length&&this._removeFeatures(k);c&&c.refreshTracks(q)},_updateFeatures:function(b){var a=this.featureLayer,c,m,d=[];c=a._trackManager;m=a._trackIdField;r.forEach(b,function(b){var h=b.updates;b=this._getFeature(b.oid);var q;if(b){h.geometry&&b.setGeometry(h.geometry);
h=h.attributes||{};for(q in h)h.hasOwnProperty(q)&&(b.attributes[q]=h[q]);b.visible=this._checkFeatureTimeIntersects(b);c&&b.attributes[m]?d.push(b.attributes[m]):a._repaint(b,null,!0)}},this);d.length&&c.refreshTracks(d)},_redrawAllTracks:function(){var b=this.featureLayer._trackManager,a;if(b&&(a=b.trimTracks())&&0<a.length)this._removeFeatures(a),b.refreshTracks()},_flushDrawBuffer:function(){clearTimeout(this._timeoutId);var b=this._drawBuffer,a=b.adds.splice(0,b.adds.length),c=b.updates.splice(0,
b.updates.length),b=this.featureLayer;if(!b)return!1;b.updating||b._fireUpdateStart();this._addFeatures(a);this._updateFeatures(c);if((a=this._getExpiredFeatures())&&a.length)this._removeFeatures(a),b._trackManager&&b._trackManager.removeFeatures(a);b._purge();b._fireUpdateEnd();this._timeoutId=null},_clearDrawBuffer:function(){var b=this._timeoutId,a=this._drawBuffer,c=a.adds,a=a.updates;b&&clearTimeout(b);c.splice(0,c.length);a.splice(0,a.length);this._timeoutId=null},_clearTimeBin:function(){this._featuresByTime=
{};this._lastEndTimeCheck=1E3*Math.ceil(Date.now()/1E3)},_clearFeatureMap:function(){this._featureMap={}},_setRefreshRate:function(b){b=b||0===b?b:200;0>b&&(b=200);this._refreshRate=b},_checkFeatureTimeIntersects:function(b){var a=this.featureLayer,c=a.getMap(),c=c?c.timeExtent:null;return!c||!a.timeInfo||!a.timeInfo.startTimeField&&!a.timeInfo.endTimeField?!0:0<a._filterByTime([b],c.startTime,c.endTime).match.length},_getRequestId:function(b){return("_"+b.name+b.layerId+b._ulid).replace(/[^a-zA-Z0-9\_]+/g,
"_")},_fetchArchive:function(b){var a=this.featureLayer,g,m,d,l,h;a._fireUpdateStart();if(b&&this.map){g=new k(b);m=new u;b=this.map;d=a.getFilter()||{};l=d.where||"1\x3d1";h=d.geometry?c.fromJson(d.geometry):null;d=d.outFields?d.outFields.split(","):["*"];m.geometry=h;m.where=l;m.outFields=d;m.returnGeometry=!0;m.outSpatialReference=new e(b.spatialReference.toJson());a._usePatch&&(b=this._getRequestId(a),this._cancelPendingRequest(null,b));var q=0,v=this,z=null,f=function(a){q++;g.execute(m).then(function(b){a(null,
b)},function(b){a(b)})},p=function(b,h){b?2<=q||!a._relatedUrl?v._queryErrorHandler(Error("Could not get features from related feature service")):(z={relatedFeatureWarning:"Querying related feature service using the current filter failed. All related features are displayed, and the filter is applied to the stream service only"},m.where="1\x3d1",f(p)):v._drawFeatures(h,z)};f(p)}else return this._fireUpdateEnd({error:"Archive data cannot be fetched if no feature service url is provided or if the layer is not added to a map"}),
!1},_queryErrorHandler:function(b){this._purgeRequests();var a=this.featureLayer;a._errorHandler(b);a._fireUpdateEnd(b)},_getExpiredFeatures:function(){var b,a,c,m=[],d=[];if(!this.featureLayer._endTimeField&&!this._maxFeatureAge)return d;b=1E3*Math.floor(this._lastEndTimeCheck/1E3);this._lastEndTimeCheck=a=1E3*Math.ceil(Date.now()/1E3);if(b&&b!==a)for(c=this._featuresByTime;b<=a;b+=1E3)c[b]&&(m=m.concat(c[b]),delete c[b]);r.forEach(m,function(a){(a=this._getFeature(a))&&d.push(a)},this);return d}});
s("extend-esri")&&n.setObject("layers._StreamMode",f,p);return f})},"esri/tasks/StatisticDefinition":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(f,n,r,s){f=f(null,{declaredClass:"esri.tasks.StatisticDefinition",toJson:function(){return{statisticType:this.statisticType,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount}}});
r("extend-esri")&&n.setObject("tasks.StatisticDefinition",f,s);return f})},"esri/layers/GridLayout":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../geometry/Extent ../geometry/Polyline".split(" "),function(f,n,r,s,p,e,u,k){f=f(null,{declaredClass:"esri.layers._GridLayout",constructor:function(c,d,b,a){this.origin=c;this.cellWidth=d.width;this.cellHeight=d.height;this.mapWidth=b.width;this.mapHeight=b.height;this.srInfo=a},setResolution:function(c){this._resolution=
(c.xmax-c.xmin)/this.mapWidth;this.srInfo&&(c=Math.round(2*this.srInfo.valid[1]/this._resolution),c=Math.round(c/this.cellWidth),this._frameStats=[c,0,c-1])},getCellCoordinates:function(c){var d=this._resolution,b=this.origin;return{row:Math.floor((b.y-c.y)/(this.cellHeight*d)),col:Math.floor((c.x-b.x)/(this.cellWidth*d))}},normalize:function(c){var d=this._frameStats;if(d){var b=d[0],a=d[1],d=d[2];c<a?(c%=b,c=c<a?c+b:c):c>d&&(c%=b)}return c},intersects:function(c,d){var b=this.srInfo;return b?r.some(d._getParts(b),
function(a){return c.intersects(a.extent)}):c.intersects(d)},getCellExtent:function(c,d){var b=this._resolution,a=this.origin,g=this.cellWidth,m=this.cellHeight;return new u(d*g*b+a.x,a.y-(c+1)*m*b,(d+1)*g*b+a.x,a.y-c*m*b,new e(a.spatialReference.toJson()))},getLatticeID:function(c){var d=this.getCellCoordinates({x:c.xmin,y:c.ymax}),b=this.getCellCoordinates({x:c.xmax,y:c.ymin});c=d.row;var a=b.row,d=this.normalize(d.col),b=this.normalize(b.col);return c+"_"+a+"_"+d+"_"+b},sorter:function(c,d){return c<
d?-1:1},getCellsInExtent:function(c,d){var b=this.getCellCoordinates({x:c.xmin,y:c.ymax}),a=this.getCellCoordinates({x:c.xmax,y:c.ymin}),g=b.row,m=a.row,b=b.col,a=a.col,t=[],l,h,q,v=[],e=[],f,p,n,r=[];for(l=g;l<=m;l++)for(h=b;h<=a;h++)q=this.normalize(h),c=this.getCellExtent(l,q),t.push({row:l,col:q,extent:c,resolution:this._resolution}),d&&(v.push(c.xmin,c.xmax),e.push(c.ymin,c.ymax));b=this.normalize(b);a=this.normalize(a);v.sort(this.sorter);e.sort(this.sorter);h=v.length;for(l=h-1;0<=l;l--)l<
h-1&&v[l]===v[l+1]&&v.splice(l,1);h=e.length;for(l=h-1;0<=l;l--)l<h-1&&e[l]===e[l+1]&&e.splice(l,1);if(v.length&&e.length){q=v[0];f=v[v.length-1];p=e[0];n=e[e.length-1];h=v.length;for(l=0;l<h;l++)r.push([[v[l],n],[v[l],p]]);h=e.length;for(l=0;l<h;l++)r.push([[q,e[l]],[f,e[l]]]);l=new k({paths:r,spatialReference:this.origin.spatialReference.toJson()});t.push({latticeID:g+"_"+m+"_"+b+"_"+a,lattice:l,resolution:this._resolution})}return{minRow:g,maxRow:m,minCol:b,maxCol:a,cells:t}}});s("extend-esri")&&
n.setObject("layers._GridLayout",f,p);return f})},"esri/layers/FeatureEditResult":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(f,n,r,s){f=f(null,{declaredClass:"esri.layers.FeatureEditResult",constructor:function(f){f&&n.isObject(f)&&(this.objectId=f.objectId,this.success=f.success,f.success||(f=f.error,this.error=Error(),this.error.code=f.code,this.error.message=f.description))}});r("extend-esri")&&n.setObject("layers.FeatureEditResult",f,s);return f})},
"esri/layers/TrackManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../graphic ../geometry/Polyline ./GraphicsLayer".split(" "),function(f,n,r,s,p,e,u,k){f=f(null,{declaredClass:"esri.layers._TrackManager",constructor:function(c){this.layer=c;this.trackMap={};this.trackLineMap={}},initialize:function(c){this.map=c;var d=this.layer,b=d._getRenderer(),b=b&&b.trackRenderer;if("esriGeometryPoint"===d.geometryType){var a=this.container=new k._GraphicsLayer({id:d.id+
"_tracks",_child:!0,visible:d.visible,minScale:d.minScale,maxScale:d.maxScale});a.loaded=!0;a.onLoad(a);a._setMap(c,d._div);a.setRenderer(b);d.on("visibility-change",n.hitch(this,function(a){this.container.setVisibility(a.visible);this.container.evaluateSuspension()}));d.on("scale-range-change",n.hitch(this,function(){this.container.setScaleRange(this.layer.minScale,this.layer.maxScale)}))}},addFeatures:function(c){var d=this.trackMap,b=this.layer,a=b._trackIdField,g=[];r.forEach(c,function(b){var c=
b.attributes[a];(d[c]=d[c]||[]).push(b);-1===r.indexOf(g,c)&&g.push(c)});var m=b._startTimeField,e=b.objectIdField,l=function(a,b){var c=a.attributes[m],l=b.attributes[m];return c===l?a.attributes[e]<b.attributes[e]?-1:1:c<l?-1:1};r.forEach(g,function(a){d[a].sort(l)})},trimTracks:function(c){function d(c){for(c=b[c]||[];c.length>a;)g.push(c.shift())}var b=this.trackMap,a=this.layer.maximumTrackPoints||0,g=[],m;if(!a)return g;if(c)r.forEach(c,function(a){d(a)});else for(m in b)b.hasOwnProperty(m)&&
d(m);return g},drawTracks:function(c){function d(h){var c=g[h],l,d,f;d=b.trackLineMap[h];a.remove(d);delete b.trackLineMap[h];if(!c||2>c.length)return!1;d=[];for(l=c.length-1;0<=l;l--)(f=c[l].geometry)&&d.push([f.x,f.y]);c={};c[k]=h;1<d.length&&(d=new e(new u({paths:[d],spatialReference:m}),null,c),a.add(d),b.trackLineMap[h]=d)}var b=this,a=this.container,g,m,k,l;if(a)if(g=this.trackMap,m=this.map.spatialReference,k=this.layer._trackIdField,c)r.forEach(c,function(a){d(a)});else for(l in g)g.hasOwnProperty(l)&&
d(l)},refreshTracks:function(c){function d(c){var h,d;b.drawTracks([c]);if(m&&m.latestObservationRenderer){c=a[c]||[];h=c.length;for(d=0;d<h;d++)g._repaint(c[d],null,!0)}}var b=this,a=this.trackMap,g=this.layer,m=g._getRenderer(),e;if(c)r.forEach(c,function(a){d(a)});else for(e in a)a.hasOwnProperty(e)&&d(e);this.moveLatestToFront()},moveLatestToFront:function(c){r.forEach(this.getLatestObservations(c),function(c){var b=c._shape;b&&b._moveToFront();this._repaint(c,null,!0)},this.layer)},getLatestObservations:function(c){function d(a){a=
g[a];return a[a.length-1]}var b=[],a=this.layer._getRenderer(),g=this.trackMap,m;if(!a.latestObservationRenderer)return b;if(c)r.forEach(c,function(a){b.push(d(a))});else for(m in g)g.hasOwnProperty(m)&&b.push(d(m));return b},clearTracks:function(c){var d=this.getLatestObservations(c),b=this.container,a;c?r.forEach(c,function(c){delete this.trackMap[c];b&&(a=this.trackLineMap[c],b.remove(a),delete this.trackLineMap[c])},this):(this.trackMap={},this.trackLineMap={},b&&b.clear());r.forEach(d,function(a){this._repaint(a,
null,!0)},this.layer)},isLatestObservation:function(c){var d=this.trackMap[c.attributes[this.layer._trackIdField]];return d?d[d.length-1]===c:!1},destroy:function(){var c=this.container;c&&(c.clear(),c._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});s("extend-esri")&&n.setObject("layers._TrackManager",f,p);return f})},"esri/layers/FeatureType":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../symbols/jsonUtils ./RangeDomain ./CodedValueDomain ./InheritedDomain ./FeatureTemplate".split(" "),
function(f,n,r,s,p,e,u,k,c,d,b){f=f(null,{declaredClass:"esri.layers.FeatureType",constructor:function(a){if(a&&n.isObject(a)){this.id=a.id;this.name=a.name;var g=a.symbol;g&&(this.symbol=u.fromJson(g));var g=a.domains,m,e=this.domains={};for(m in g)if(g.hasOwnProperty(m)){var l=g[m];switch(l.type){case "range":e[m]=new k(l);break;case "codedValue":e[m]=new c(l);break;case "inherited":e[m]=new d(l)}}if(m=a.templates){g=this.templates=[];for(a=0;a<m.length;a++)g.push(new b(m[a]))}}},toJson:function(){var a=
{id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()},b,c=this.domains,d=this.templates,l=e.fixJson;if(c){var h=a.domains={};for(b in c)c.hasOwnProperty(b)&&(h[b]=c[b]&&c[b].toJson());l(h)}d&&(a.templates=r.map(d,function(a){return a.toJson()}));return l(a)}});s("extend-esri")&&n.setObject("layers.FeatureType",f,p);return f})},"esri/layers/FeatureTemplate":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../lang ../graphic".split(" "),function(f,n,r,s,p,e){f=
f(null,{declaredClass:"esri.layers.FeatureTemplate",constructor:function(f){f&&n.isObject(f)&&(this.name=f.name,this.description=f.description,this.drawingTool=f.drawingTool,f=f.prototype,this.prototype=new e(f.geometry,null,f.attributes))},toJson:function(){return p.fixJson({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()})}});n.mixin(f,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",
TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",
TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});r("extend-esri")&&n.setObject("layers.FeatureTemplate",f,s);return f})},"esri/layers/OnDemandMode":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has ../kernel ../geometry/Point ../tasks/query ./RenderMode ./GridLayout".split(" "),function(f,n,r,s,p,e,u,k,c,d){f=f([c],{declaredClass:"esri.layers._OnDemandMode",constructor:function(b){this.featureLayer=b;this._featureMap={};this._queryErrorHandler=r.hitch(this,
this._queryErrorHandler)},initialize:function(b){this.inherited(arguments);var a=this.featureLayer,c=a._srInfo;this._gridLayer=new d(new u(c?c.valid[0]:b.extent.xmin,c?c.valid[1]:b.extent.ymax,b.spatialReference),{width:a._tileWidth,height:a._tileHeight},{width:b.width,height:b.height},c);this._cellMap={};this._gridLayer.setResolution(b.extent)},startup:function(){this._ioQueue=[];this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(b){this._init&&
(2>b?this._zoomHandler():console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this.inherited(arguments)},drawFeature:function(b){var a=this._gridLayer,c=b.geometry,d=[];if(c)for(var d=a.getCellsInExtent("point"===c.type?{xmin:c.x,ymin:c.y,xmax:c.x,ymax:c.y}:c.getExtent(),!1).cells,a=this._cellMap,e,l=b.attributes[this.featureLayer.objectIdField],
h,q,k,c=0;c<d.length;c++)e=d[c],h=e.latticeID,q=e.row,k=e.col,h?e=a[h]=a[h]||e:(a[q]=a[q]||{},e=a[q][k]=a[q][k]||e),e.features=e.features||[],e.features.push(b),this._addFeatureIIf(l,b),this._incRefCount(l)},suspend:function(){this._init&&this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},refresh:function(){this._zoomHandler()},_enableConnectors:function(){var b=this.map;this._zoomConnect=n.connect(b,"onZoomEnd",this,this._zoomHandler);this._panConnect=
n.connect(b,"onPanEnd",this,this._panHandler);this._resizeConnect=n.connect(b,"onResize",this,this._panHandler)},_disableConnectors:function(){n.disconnect(this._zoomConnect);n.disconnect(this._panConnect);n.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var b=this.featureLayer,a=this.map;b.suspended||(b._fireUpdateStart(),this._clearIIf(),(b=b._trackManager)&&b.clearTracks(),this._cellMap={},this._gridLayer.setResolution(a.extent),this._sendRequest())},_panHandler:function(b){this.featureLayer._fireUpdateStart();
this._sendRequest(this.featureLayer._resized&&b)},_getRequestId:function(b,a){return("_"+b.name+b.layerId+b._ulid+"_"+a.resolution+"_"+(a.latticeID||a.row+"_"+a.col)).replace(/[^a-zA-Z0-9\_]+/g,"_")},_sendRequest:function(b){this._exceeds=!1;var a=this.featureLayer,c=this.map;b=b||c.extent;c=this._gridLayer.getCellsInExtent(b,a.latticeTiling).cells;if(!a.isEditable())var d=this._cellMap,c=s.filter(c,function(a){if(a.lattice){if(d[a.latticeID])return!1}else if(d[a.row]&&d[a.row][a.col])return!1;return!0});
var e=a.getOutFields(),l=a.getDefinitionExpression(),h=a._getOffsettedTE(a._mapTimeExtent),q=a.supportsAdvancedQueries?a.getOrderByFields():null,f=a._usePatch,n=this._ioQueue,p,r=this,u=this._drawFeatures,A,x,D;this._pending=this._pending||0;for(p=0;p<c.length;p++){A=c[p];x=new k;x.geometry=A.extent||A.lattice;x.outFields=e;x.where=l;a.latticeTiling&&A.extent&&(x.spatialRelationship=k.SPATIAL_REL_CONTAINS);x.returnGeometry=!0;x.timeExtent=h;a._ts&&(x._ts=(new Date).getTime());x.orderByFields=q;x.multipatchOption=
a.multipatchOption;x.maxAllowableOffset=a._maxOffset;x.quantizationParameters=a._quantizationParameters;if((D=a.advancedQueryCapabilities)&&D.supportsQueryWithResultType)x.resultType="tile";D=null;if(f&&(D=this._getRequestId(a,A),this._isPending(D)))continue;this._pending++;n.push(a._task.execute(x,function(){var a=A;return function(b){u.apply(r,[b,a])}}.call(this),this._queryErrorHandler,D))}this._removeOldCells(b);this._endCheck()},_drawFeatures:function(b,a){this._exceeds=this._exceeds||b.exceededTransferLimit;
this._finalizeIO();var c=this.map.extent,d=a.extent,e=a.row,l=a.col,h=this.featureLayer.objectIdField,q=b.features,k=this._gridLayer,f=this._cellMap,p=a.latticeID,n=p?f[p]:f[e]&&f[e][l];if(a.resolution!=k._resolution||(p?p!==k.getLatticeID(c):!k.intersects(d,c)))n&&this._removeCell(e,l,p);else if(n)this._updateCell(n,q);else{a.features=q;p?f[p]=a:(f[e]=f[e]||{},f[e][l]=a);d=q.length;for(c=0;c<d;c++)e=q[c],l=e.attributes[h],this._addFeatureIIf(l,e),this._incRefCount(l)}this._endCheck()},_queryErrorHandler:function(b){this._finalizeIO();
this.featureLayer._errorHandler(b);this._endCheck(!0)},_finalizeIO:function(){this._purgeRequests();this._pending--},_endCheck:function(b){if(0===this._pending){this._processIOQueue();var a=this.featureLayer,c=a._trackManager;c&&(c.clearTracks(),c.addFeatures(a.graphics),a._ager&&s.forEach(a.graphics,function(b){b._shape&&a._repaint(b)}),c.moveLatestToFront(),c.drawTracks());this.featureLayer._fireUpdateEnd(b&&Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:!0}:
null);if(this._exceeds)a.onQueryLimitExceeded()}},_processIOQueue:function(b){this._ioQueue=s.filter(this._ioQueue,function(a){return-1<a.fired?!1:!0});b&&s.forEach(this._ioQueue,this._cancelPendingRequest)},_removeOldCells:function(b){var a=this._cellMap,c=this._gridLayer,d,e;for(d in a)if(a[d]){var l=a[d],h=l.latticeID,q=0,k=0;if(h)q++,h!==c.getLatticeID(b)&&(this._removeCell(null,null,h),k++);else for(e in l)l[e]&&(q++,c.intersects(l[e].extent,b)||(this._removeCell(d,e),k++));k===q&&delete a[d]}},
_updateCell:function(b,a){var c=this.featureLayer,d=c.objectIdField,c=c._selectedFeatures,e,l=a.length;b.features=b.features||[];for(e=0;e<l;e++){var h=a[e],q=h.attributes[d],k=this._addFeatureIIf(q,h);k===h?(this._incRefCount(q),b.features.push(k)):q in c||(k.setGeometry(h.geometry),k.setAttributes(h.attributes))}},_removeCell:function(b,a,c){var d=this._cellMap,e=this.featureLayer,l=e.objectIdField,h=c?d[c]:d[b]&&d[b][a];if(h){c?delete d[c]:delete d[b][a];b=h.features;for(a=0;a<b.length;a++)c=b[a].attributes[l],
this._decRefCount(c),c in e._selectedFeatures||this._removeFeatureIIf(c)}}});p("extend-esri")&&r.setObject("layers._OnDemandMode",f,e);return f})},"esri/tasks/QueryTask":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/_base/json dojo/has ../kernel ../request ../deferredUtils ../geometry/Extent ../geometry/normalizeUtils ./Task ./FeatureSet".split(" "),function(f,n,r,s,p,e,u,k,c,d,b,a,g){f=f(a,{declaredClass:"esri.tasks.QueryTask",_eventMap:{complete:["featureSet"],
"execute-for-count-complete":["count"],"execute-for-ids-complete":["objectIds"],"execute-relationship-query-complete":["featureSets"]},constructor:function(a,b){this._handler=n.hitch(this,this._handler);this._relationshipQueryHandler=n.hitch(this,this._relationshipQueryHandler);this._executeForIdsHandler=n.hitch(this,this._executeForIdsHandler);this._countHandler=n.hitch(this,this._countHandler);this._extentHandler=n.hitch(this,this._extentHandler);this.source=b&&b.source;this.gdbVersion=b&&b.gdbVersion;
this.registerConnectEvents()},__msigns:[{n:"execute",c:4,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForIds",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForCount",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForExtent",c:3,a:[{i:0,p:["geometry"]}],e:2}],onComplete:function(){},onExecuteRelationshipQueryComplete:function(){},onExecuteForIdsComplete:function(){},onExecuteForCountComplete:function(){},onExecuteForExtentComplete:function(){},execute:function(a,b,c,h,d){var e=d.assembly;a=this._encode(n.mixin({},
this._url.query,{f:"json"},a.toJson(e&&e[0])));var f=this._handler,g=this._errorHandler;this.source&&(e={source:this.source.toJson()},a.layer=p.toJson(e));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return k({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,h){f(a,h,b,c,d.dfd)},error:function(a){g(a,c,d.dfd)},callbackSuffix:h},this.requestOptions)},executeRelationshipQuery:function(a,b,d){a=this._encode(n.mixin({},this._url.query,{f:"json"},a.toJson()));var h=
this._relationshipQueryHandler,e=this._errorHandler;this.gdbVersion&&(a.gdbVersion=this.gdbVersion);var f=new s(c._dfdCanceller);f._pendingDfd=k({url:this._url.path+"/queryRelatedRecords",content:a,callbackParamName:"callback",load:function(a,c){h(a,c,b,d,f)},error:function(a){e(a,d,f)}},this.requestOptions);return f},executeForIds:function(a,b,c,h){var d=h.assembly;a=this._encode(n.mixin({},this._url.query,{f:"json",returnIdsOnly:!0},a.toJson(d&&d[0])));var e=this._executeForIdsHandler,f=this._errorHandler;
this.source&&(d={source:this.source.toJson()},a.layer=p.toJson(d));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return k({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,d){e(a,d,b,c,h.dfd)},error:function(a){f(a,c,h.dfd)}},this.requestOptions)},executeForCount:function(a,b,c,d){var e=d.assembly;a=this._encode(n.mixin({},this._url.query,{f:"json",returnIdsOnly:!0,returnCountOnly:!0},a.toJson(e&&e[0])));var f=this._countHandler,g=this._errorHandler;this.source&&
(e={source:this.source.toJson()},a.layer=p.toJson(e));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return k({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,e){f(a,e,b,c,d.dfd)},error:function(a){g(a,c,d.dfd)}},this.requestOptions)},executeForExtent:function(a,b,c,d){var e=d.assembly;a=this._encode(n.mixin({},this._url.query,{f:"json",returnExtentOnly:!0,returnCountOnly:!0},a.toJson(e&&e[0])));var f=this._extentHandler,g=this._errorHandler;this.source&&(e={source:this.source.toJson()},
a.layer=p.toJson(e));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return k({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,e){f(a,e,b,c,d.dfd)},error:function(a){g(a,c,d.dfd)}},this.requestOptions)},_handler:function(a,b,c,d,e){try{var k=new g(a);this._successHandler([k],"onComplete",c,e)}catch(f){this._errorHandler(f,d,e)}},_relationshipQueryHandler:function(a,b,c,d,e){try{var k=a.geometryType,f=a.spatialReference,p={};r.forEach(a.relatedRecordGroups,function(a){var b=
{};b.geometryType=k;b.spatialReference=f;b.features=a.relatedRecords;b=new g(b);if(null!=a.objectId)p[a.objectId]=b;else for(var c in a)a.hasOwnProperty(c)&&"relatedRecords"!==c&&(p[a[c]]=b)});this._successHandler([p],"onExecuteRelationshipQueryComplete",c,e)}catch(n){this._errorHandler(n,d,e)}},_executeForIdsHandler:function(a,b,c,d,e){try{this._successHandler([a.objectIds],"onExecuteForIdsComplete",c,e)}catch(k){this._errorHandler(k,d,e)}},_countHandler:function(a,b,c,d,e){try{var k,f=a.features,
g=a.objectIds;if(g)k=g.length;else{if(f)throw Error("Unable to perform query. Please check your parameters.");k=a.count}this._successHandler([k],"onExecuteForCountComplete",c,e)}catch(p){this._errorHandler(p,d,e)}},_extentHandler:function(a,b,c,h,e){try{a.extent&&(a.extent=new d(a.extent)),this._successHandler([a],"onExecuteForExtentComplete",c,e)}catch(k){this._errorHandler(k,h,e)}}});b._createWrappers(f);e("extend-esri")&&n.setObject("tasks.QueryTask",f,u);return f})},"esri/layers/SelectionMode":function(){define(["dojo/_base/declare",
"dojo/_base/lang","dojo/has","../kernel","./RenderMode"],function(f,n,r,s,p){f=f([p],{declaredClass:"esri.layers._SelectionMode",constructor:function(e){this.featureLayer=e;this._featureMap={}},propertyChangeHandler:function(e){this._init&&0===e&&this._applyTimeFilter()},resume:function(){this.propertyChangeHandler(0)}});r("extend-esri")&&n.setObject("layers._SelectionMode",f,s);return f})},"esri/layers/HeatmapManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/aspect dojo/_base/array require ../kernel ../sniff ../geometry/Point ../geometry/webMercatorUtils ./MapImage ../renderers/HeatmapRenderer ../tasks/query dojo/_base/fx".split(" "),
function(f,n,r,s,p,e,u,k,c,d,b,a,g){function m(){}function t(a){var b=a.layer;return{geometry:a.geometry,attributes:a.attributes,getLayer:function(){return b}}}f=f(null,{declaredClass:"esri.layers.HeatmapManager",heatmapRenderer:null,sourceLayer:null,imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(a){this.sourceLayer=a;this._hndls=[]},initialize:function(a){this.map=a;var c=this.sourceLayer,d=c.renderer;c.setDrawMode(!1);this.imageLayer=a._getMapImageLyr();var e=this;this.heatmapRenderer=
d instanceof b?d:(d.getRendererInfoByZoom(a.getZoom())||d.getRendererInfoByScale(a.getScale())).renderer;this._setupDraw=this._setupDraw.bind(this);this.recalculateHeatmap=this.recalculateHeatmap.bind(this);this._removeRenderer=this._removeRenderer.bind(this);this._handleRendererChange=this._handleRendererChange.bind(this);this._rendererChangeHandle=this.sourceLayer.on("renderer-change",this._handleRendererChange);this._handleOpacityChange=this._handleOpacityChange.bind(this);this._reprojectFeature=
this._reprojectFeature.bind(this);p(["../workers/heatmapCalculator"],function(a){e._calculator=new a(n.mixin({width:e.map.width,height:e.map.height},e._getOptions()));e._setupRenderer();e.heatmapRenderer.getStats=a.calculateStats;e.heatmapRenderer.getHistogramData=a.getHistogramData})},destroy:function(){this._removeHandlers();this._rendererChangeHandle&&this._rendererChangeHandle.remove();this._rendererChangeHandle=this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=null},
_handleRendererChange:function(a){var c=a.renderer,d=c instanceof b;this.heatmapRenderer?d?this.heatmapRenderer=c:this._removeRenderer(a):d&&(this.heatmapRenderer=c,this.sourceLayer&&this.map&&this._setupRenderer())},_handleOpacityChange:function(a){a=a.opacity;var b=this._getImageBySourceId(this.sourceLayer.id);b&&b.setOpacity(a)},_setupRenderer:function(){var a=this._hndls,b=this.sourceLayer,c=this.map,d=this;b._originalDraw=b._draw;b._draw=m;b._div.clear();clearTimeout(this._resetTimer);this._resetTimer=
setTimeout(this._resetGraphics.bind(this),250);a.push(b.on("update-end",this._setupDraw));a.push(b.on("suspend",function(a){(a=d._getImageBySourceId(d.sourceLayer.id))&&a.hide()}));a.push(b.on("resume",function(a){(a=d._getImageBySourceId(d.sourceLayer.id))&&a.show()}));a.push(r.after(b,"redraw",this._setupDraw));a.push(c.on("layer-remove",function(a){a.layer==b&&((a=d._getImageBySourceId(d.sourceLayer.id))&&d.imageLayer.removeImage(a),d._removeRenderer({target:b}))}));b._collection&&a.push(b.on("graphic-add",
function(a){d._reprojectFeature(a.graphic);d._setupDraw()}));1!==b.mode&&(a.push(c.on("resize, pan-end",this._setupDraw)),a.push(c.on("zoom-end",this._setupDraw)));a.push(b.on("opacity-change",this._handleOpacityChange));this.imageLayer.suspended&&this.imageLayer.resume();b.graphics&&b.graphics.length&&(b.graphics[0].geometry&&!c.spatialReference.equals(b.graphics[0].geometry.spatialReference)&&s.forEach(b.graphics,function(a){this._reprojectFeature(a)}.bind(this)),this._setupDraw())},_setupDraw:function(){if(!this._drawTimer){var a=
this;this._drawTimer=setTimeout(function(){clearTimeout(a._drawTimer);a._drawTimer=null;a.sourceLayer._getRenderer().isInstanceOf(b)&&a.recalculateHeatmap()},16)}},_removeRenderer:function(a){var b=a.target;b._draw=b._originalDraw;delete b._originalDraw;b.setDrawMode(!0);this._removeHandlers();this._hndls=[];var c=this._getImageBySourceId(this.sourceLayer.id);c&&this.imageLayer.removeImage(c);clearTimeout(this._drawTimer);clearTimeout(this._resetTimer);this._drawTimer=this._resetTimer=null;b.renderer!=
a.renderer&&b.renderer.getRendererInfo?this.heatmapRenderer=null:(b.redraw(),this.destroy())},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&this._doWorkerCalculation()},_reprojectFeature:function(a){if(a&&a.geometry){var b=a.geometry,d=this.map.spatialReference;d.equals(b.spatialReference)||(b=c.project(b,d),null==b?console.log("Unable to reproject features to map's spatial reference. Please convert feature geometry before adding to layer"):a.geometry=
b)}},_doWorkerCalculation:function(){},_doMainCalculation:function(){var b=this.sourceLayer,c=this.map,e=this.heatmapRenderer,k=this.map.extent,f=this.map.width,g=this.map.height,m=this._calculator,p=this,r=function(a){a=p._getScreenPoints(a.features,c,b);a=m.calculateImageData(n.mixin({screenPoints:a,mapinfo:{extent:[k.xmin,k.ymin,k.xmax,k.ymax],resolution:c.getResolution()},width:f,height:g},p._getOptions()));a=e.getSymbol(t({geometry:c.extent,attributes:{size:[f,g],imageData:a},layer:b}));a=new d({extent:c.extent,
href:a.url,opacity:0,sourceId:b.id});p._swapMapImages(a,p._getImageBySourceId(b.id));b.suspended&&a.hide()},s={geometry:c.extent,timeExtent:b.useMapTime?c.timeExtent:void 0,spatialRelationship:a.SPATIAL_REL_INTERSECTS};null!=b._canDoClientSideQuery(s)?b.queryFeatures(s,r):r({features:b.graphics})},_getScreenPoints:function(a,b,c){var d=[],e=a.length,f=0,g=0,m,p=new k(b.extent.xmin,b.extent.ymax,b.spatialReference),n=b.toScreen(p),r=n.x,n=n.y,u=b.getResolution(),t;for((g=b.extent.getCacheValue("_parts"))&&
(t=s.map(g,function(a){return c._intersects(b,a.extent)[0]}));e--;)g=a[e],g.geometry&&(m={x:Math.ceil((g.geometry.x-p.x)/u+r),y:Math.floor((p.y-g.geometry.y)/u-n),attributes:g.attributes},t&&(g=1<t.length&&m.x<-t[0]?t[1]:t[0],m.x+=g),d[f++]=m);return d},_getImageBySourceId:function(a){var b=this.imageLayer.getImages(),b=s.filter(b,function(b){return b.sourceId==a});if(b.length)return b[b.length-1]},_swapMapImages:function(a,b){function c(){d.removeImage(b)}var d=this.imageLayer,e=this.sourceLayer.opacity||
1;d.addImage(a);g.anim(a._node,{opacity:e},null,null,function(){a.opacity=e});null!=b&&g.anim(b._node,{opacity:0},null,null,c)},_removeHandlers:function(){if(null!=this._hndls)for(var a=this._hndls.length;a--;)this._hndls[a].remove()},_getOptions:function(){var a=this.heatmapRenderer;return{blurRadius:a.blurRadius,gradient:a.gradient,maxPixelIntensity:a.maxPixelIntensity,minPixelIntensity:a.minPixelIntensity,field:a.field,fieldOffset:a.fieldOffset}},_resetGraphics:function(){clearTimeout(this._resetTimer);
this._resetTimer=null;for(var a=this.sourceLayer.graphics,b=a.length,c;b--;)c=a[b],c._shape=c._offsets=void 0}});u("extend-esri")&&n.setObject("layers.HeatmapManager",f,e);return f})},"esri/layers/SnapshotMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../SpatialReference ../tasks/query ./RenderMode".split(" "),function(f,n,r,s,p,e,u){f=f([u],{declaredClass:"esri.layers._SnapshotMode",constructor:function(e){this.featureLayer=e;this.pagination=e.queryPagination;this._featureMap=
{};this._drawFeatures=n.hitch(this,this._drawFeatures);this._queryErrorHandler=n.hitch(this,this._queryErrorHandler)},startup:function(){this.pagination=this.pagination&&null!=this.featureLayer.maxRecordCount;this.featureLayer._collection?this._applyTimeFilter():this._fetchAll()},propertyChangeHandler:function(e){this._init&&(e?this.featureLayer._collection?console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id \x3d "+
this.featureLayer.id):this._fetchAll():this._applyTimeFilter())},drawFeature:function(e){var c=e.attributes[this.featureLayer.objectIdField];this._addFeatureIIf(c,e);this._incRefCount(c)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var e=this.featureLayer;e._collection?(e._fireUpdateStart(),e._refresh(!0),e._fireUpdateEnd()):this._fetchAll()},_getRequestId:function(e){return("_"+e.name+e.layerId+e._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchAll:function(){var e=this.featureLayer;
!e._collection&&!e.suspended&&(e._fireUpdateStart(),this._clearIIf(),this._sendRequest())},_sendRequest:function(f){var c=this.map,d=this.featureLayer,b=d.getDefinitionExpression(),a=new e;a.outFields=d.getOutFields();a.where=b||"1\x3d1";a.returnGeometry=!0;a.outSpatialReference=new p(c.spatialReference.toJson());a.timeExtent=d.getTimeDefinition();a.maxAllowableOffset=d._maxOffset;a.quantizationParameters=d._quantizationParameters;d._ts&&(a._ts=(new Date).getTime());a.orderByFields=d.supportsAdvancedQueries?
d.getOrderByFields():null;a.multipatchOption=d.multipatchOption;this.pagination&&(this._start=a.start=null==f?0:f,a.num=d.maxRecordCount);var g;d._usePatch&&(g=this._getRequestId(d),this._cancelPendingRequest(null,g));d._task.execute(a,this._drawFeatures,this._queryErrorHandler,g)},_drawFeatures:function(e){this._purgeRequests();var c=e.features,d=this.featureLayer,b=d.objectIdField,a,f=c.length,m=e.exceededTransferLimit&&!d._collection,p=d._selectedFeatures,l=d.mode===d.constructor.MODE_AUTO,h,n,
r;for(a=0;a<f;a++)n=c[a],r=n.attributes[b],h=this._addFeatureIIf(r,n),this._incRefCount(r),l&&(h!==n&&p[r])&&(h.setGeometry(n.geometry),h.setAttributes(n.attributes));this._applyTimeFilter(!0);if(!this.pagination||!m)d._fireUpdateEnd(null,e.exceededTransferLimit?{queryLimitExceeded:!0}:null);m&&(this.pagination&&this._sendRequest(this._start+d.maxRecordCount),d.onQueryLimitExceeded())},_queryErrorHandler:function(e){this._purgeRequests();var c=this.featureLayer;c._errorHandler(e);c._fireUpdateEnd(e)}});
r("extend-esri")&&n.setObject("layers._SnapshotMode",f,s);return f})},"*noref":1}});
define("esri/layers/FeatureLayer","require module dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/sniff dojo/io-query dojo/dom-construct dojo/i18n dojo/when dojo/promise/all ../kernel ../lang ../request ../config ../deferredUtils ../SpatialReference ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/jsonUtils ../tasks/QueryTask ../tasks/query ../tasks/FeatureSet ../tasks/StatisticDefinition ../geometry/Extent ../geometry/jsonUtils ../geometry/normalizeUtils ../geometry/scaleUtils ./GraphicsLayer ./Field ./TimeInfo ./FeatureType ./FeatureTemplate ./FeatureEditResult ./LabelClass ./SnapshotMode ./OnDemandMode ./SelectionMode ./StreamMode ./TrackManager ./HeatmapManager dojo/i18n!../nls/jsapi dojo/has!extend-esri?./agscommon".split(" "),function(f,
n,r,s,p,e,u,k,c,d,b,a,g,m,t,l,h,q,v,z,H,P,Q,A,x,D,R,S,T,I,G,U,L,V,W,X,Y,Z,$,aa,ba,F,ca,J,da,ea,fa,ga,M,ha){var ia=v.defaults,B=r(Y,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reHostedFS:/https?:\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxVertexCountForAuto:25E4,generalizeForScale:4E3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],
"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(a,b){this._preventInit||this._initFeatureLayer(a,b)},_initFeatureLayer:function(a,b){this.i18n=ha;b=b||{};this.showLabels=null!=b.showLabels?b.showLabels:!0;
this._outFields=b.outFields;this._defnExpr=b.definitionExpression;this._loadCallback=b.loadCallback;var c=b._usePatch;this._usePatch=null===c||void 0===c?!0:c;this._trackIdField=b.trackIdField;this.objectIdField=b.objectIdField;this._maxOffset=null!=b.maxAllowableOffset?b.maxAllowableOffset:this.maxAllowableOffset;this.quantize=null!=b.quantize?b.quantize:!0;this._optEditable=b.editable;this._optAutoGen=b.autoGeneralize;this.editSummaryCallback=b.editSummaryCallback;this.userId=b.userId;this.userIsAdmin=
b.userIsAdmin;this.useMapTime=b.hasOwnProperty("useMapTime")?!!b.useMapTime:!0;this.source=b.source;this.gdbVersion=b.gdbVersion;this.orderByFields=b.orderByFields;this.maxPointCountForAuto=null!=b.maxPointCountForAuto?b.maxPointCountForAuto:this.maxPointCountForAuto;this.maxRecordCountForAuto=null!=b.maxRecordCountForAuto?b.maxRecordCountForAuto:this.maxRecordCountForAuto;this.maxVertexCountForAuto=null!=b.maxVertexCountForAuto?b.maxVertexCountForAuto:this.maxVertexCountForAuto;this.generalizeForScale=
null!=b.generalizeForScale?b.generalizeForScale:this.generalizeForScale;this.queryPagination=null!=b.queryPagination?b.queryPagination:this.url?this.reHostedFS.test(this.url):!1;this.multipatchOption=b.multipatchOption;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var d=B,c=this.mode=h.isDefined(b.mode)?b.mode:d.MODE_ONDEMAND;this._isStream&&(this.mode=c=d.MODE_STREAM);switch(c){case d.MODE_SNAPSHOT:this.currentMode=
d.MODE_SNAPSHOT;this._mode=new J(this);this._isSnapshot=!0;break;case d.MODE_ONDEMAND:case d.MODE_AUTO:this.currentMode=d.MODE_ONDEMAND;this._tileWidth=b.tileWidth||512;this._tileHeight=b.tileHeight||512;this._mode=new da(this);this.latticeTiling=b.latticeTiling;break;case d.MODE_SELECTION:this.currentMode=d.MODE_SELECTION;this._mode=new ea(this);this._isSelOnly=!0;break;case d.MODE_STREAM:this.currentMode=d.MODE_STREAM,this._mode=new fa(this),this._isStream=!0}this._initLayer=p.hitch(this,this._initLayer);
this._selectHandler=p.hitch(this,this._selectHandler);this._editable=!1;if(p.isObject(a)&&a.layerDefinition)return this._collection=!0,this.mode=this._isStream?d.MODE_STREAM:d.MODE_SNAPSHOT,this._initLayer(a),this;this._task=new T(this.url,{source:this.source,gdbVersion:this.gdbVersion});c=this._url.path;this._fserver=!1;-1!==c.search(/\/FeatureServer\//i)&&(this._fserver=!0);this.mode===d.MODE_AUTO&&this.reHostedFS.test(this.url)&&this._queryLimit();(d=b.resourceInfo)?this._initLayer(d):(this.source&&
(d={source:this.source.toJson()},this._url.query=p.mixin(this._url.query,{layer:u.toJson(d)})),this.gdbVersion&&(this._url.query=p.mixin(this._url.query,{gdbVersion:this.gdbVersion})),q({url:c,content:p.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));this.registerConnectEvents()},_initLayer:function(a,b){if(a||b){this._json=a;this._findCredential();if(this.credential&&this.credential.ssl||a&&a._ssl)this._useSSL(),this._task._useSSL();
this.version=a.currentVersion;this.version||(this.version="capabilities"in a||"drawingInfo"in a||"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in a||"typeIdField"in a||"types"in a?10:9.3);this._collection&&(this._isStream||(this.currentMode=B.MODE_SNAPSHOT,this._mode=new J(this)),this._isSnapshot=!0,this._featureSet=a.featureSet,this._nextId=a.nextObjectId,a=a.layerDefinition);this.geometryType=a.geometryType;"string"!==typeof this.multipatchOption&&"esriGeometryMultiPatch"===
this.geometryType&&(this.multipatchOption="xyFootprint");if(a.hasOwnProperty("capabilities")){var c=this.capabilities=a.capabilities;c&&-1!==c.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=!1}else this._collection||(this._editable=this._fserver);h.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):"esriGeometryMultiPatch"===this.geometryType&&(this._editable=!1);this._json=u.toJson(this._json);if(this.isEditable())this._setMaxOffset(null);
else if(this.mode!==B.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint()))this._autoGeneralize=h.isDefined(this._optAutoGen)?this._optAutoGen:this.mode===B.MODE_ONDEMAND||this.mode===B.MODE_AUTO,delete this._optAutoGen;var c=a.effectiveMinScale||a.minScale,y=a.effectiveMaxScale||a.maxScale;!this._hasMin&&c&&this.setMinScale(c);!this._hasMax&&y&&this.setMaxScale(y);this.layerId=a.id;this.name=a.name;this.description=a.description;
this.copyright=a.copyrightText;this.type=a.type;this.displayField=a.displayField;this.defaultDefinitionExpression=a.definitionExpression;this.fullExtent=new L(a.extent);this.initialExtent=new L(this.fullExtent.toJson());this.fullExtent.spatialReference&&(this.spatialReference=new H(this.fullExtent.spatialReference.toJson()));this.defaultVisibility=a.defaultVisibility;if("esriGeometryPoint"===this.geometryType||"esriGeometryMultipoint"===this.geometryType)this.latticeTiling=!1;this.hasM=a.hasM||!1;
this.hasZ=a.hasZ||!1;this.indexedFields=a.indexedFields;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:a.supportsAdvancedQueries;this.supportsCalculate=a.supportsCalculate;this.supportsAttachmentsByUploadId=a.supportsAttachmentsByUploadId;this.supportsCoordinatesQuantization=a.supportsCoordinatesQuantization;this.quantize=this.quantize&&this.supportsCoordinatesQuantization;this.hasLabels=
a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;this.supportsRollbackOnFailureParameter=this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=a.relationships;
this.allowGeometryUpdates=h.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:!0;this.advancedQueryCapabilities=a.advancedQueryCapabilities||{supportsStatistics:this.supportsStatistics,supportsOrderBy:this.supportsAdvancedQueries,supportsDistinct:this.supportsAdvancedQueries};this.useStandardizedQueries=a.useStandardizedQueries;this.tileMaxRecordCount=a.tileMaxRecordCount;this.standardMaxRecordCount=a.standardMaxRecordCount;this._setMaxOffset(this._maxOffset,!0);this._isTable="Table"===this.type;
for(var w=this.fields=[],y=a.fields,c=0;c<y.length;c++)w.push(new Z(y[c]));if(!this.objectIdField){this.objectIdField=a.objectIdField;if(!this.objectIdField){y=a.fields;for(c=0;c<y.length;c++)if(w=y[c],"esriFieldTypeOID"===w.type){this.objectIdField=w.name;break}}!this.objectIdField&&!this._isStream&&console.debug("esri.layers.FeatureLayer: "+h.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!h.isDefined(this._nextId)){y=this.objectIdField;w=-1;if(this._collection&&y)for(var E=
(c=this._featureSet)&&c.features,f=E?E.length:0,C,c=0;c<f;c++)C=(C=E[c].attributes)&&C[y],C>w&&(w=C);this._nextId=w+1}this.globalIdField=a.globalIdField;if(c=this.typeIdField=a.typeIdField)if(c=!this._getField(c)&&this._getField(c,!0))this.typeIdField=c.name;this.visibilityField=a.visibilityField;if(y=a.defaultSymbol)this.defaultSymbol=x.fromJson(y);var k=this.types=[],g=a.types,m,l,w=(c=this.editFieldsInfo)&&c.creatorField,E=c&&c.editorField;C=w||E;f=[];if(g)for(c=0;c<g.length;c++)m=new aa(g[c]),
l=m.templates,C&&(l&&l.length)&&(f=f.concat(l)),k.push(m);g=a.templates;m=this.templates=[];if(g)for(c=0;c<g.length;c++)k=new ba(g[c]),C&&f.push(k),m.push(k);for(c=0;c<f.length;c++)if(C=p.getObject("prototype.attributes",!1,f[c]))w&&delete C[w],E&&delete C[E];if(c=a.timeInfo)this.timeInfo=new $(c),this._startTimeField=c.startTimeField,this._endTimeField=c.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?c.trackIdField=this._trackIdField:this._trackIdField=
c.trackIdField;this.hasAttachments=!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;var c=a.drawingInfo,n;if((w=c&&c.labelingInfo)&&!this.labelingInfo)this.labelingInfo=e.map(w,function(a){return new ca(a)}),this._fixLabelExpr();if(!this.renderer)if(c&&c.renderer){if(n=c.renderer,this.setRenderer(S.fromJson(n)),"classBreaks"===n.type&&this.renderer.setMaxInclusive(!0),!this._collection){var q=n.type,y=[];n=this.renderer;switch(q){case "simple":y.push(n.symbol);break;case "uniqueValue":case "classBreaks":y.push(n.defaultSymbol),
y=y.concat(e.map(n.infos,function(a){return a.symbol}))}var y=e.filter(y,h.isDefined),r=this._url.path+"/images/",s=this._getToken();e.forEach(y,function(a){var b=a.url;b&&(-1===b.search(/https?\:/)&&-1===b.indexOf("data:")&&(a.url=r+b),s&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+s))})}}else if(y)g=this.types,0<g.length?(n=new R(this.defaultSymbol,this.typeIdField),e.forEach(g,function(a){n.addValue(a.id,a.symbol)})):n=new D(this.defaultSymbol),this.setRenderer(n);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":q=
new P;break;case "esriGeometryPolyline":q=new Q;break;case "esriGeometryPolygon":q=new A;break;default:this.hasXYFootprint()&&(q=new A)}this.setRenderer(q?new D(q):null)}q=c&&c.transparency||0;!this.hasOwnProperty("opacity")&&0<q&&(this.opacity=1-q/100);if((d("ie")||7<=d("trident")||d("safari"))&&this.isEditable()&&10.02>this.version)this._ts=!0;this.statistics=a.statistics;this._fixRendererFields();this._checkFields();this._updateCaps();var t=function(){this.currentMode!==B.MODE_SNAPSHOT&&(this.queryPagination=
!1);null!=this._maxOffset&&!this._isFractionalOffsetAllowed()&&this._setMaxOffset(this._maxOffset);this.loaded=!0;this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,a(this))};this._collection?(q=this._featureSet,this._featureSet=null,this._mode._drawFeatures(new G(q)),this._fcAdded=!0,t.call(this)):this._forceIdentity(this._limitPromise?function(){var a=this;this._limitPromise.then(function(b){a._checkMode(b)});this._limitPromise.always(function(){a._limitPromise=null;t.call(a)})}:
t)}},setShowLabels:function(a){this.showLabels=a;this.onShowLabelsChange()},onShowLabelsChange:function(){},onRendererChange:function(a){this.inherited(arguments);var b=this._map;this._ager=!(!a||!a.observationAger||!a.observationRenderer);a&&"colors"in a&&"blurRadius"in a&&"maxPixelIntensity"in a?"esriGeometryPoint"==this.geometryType&&(!this._heatmapManager&&b)&&(this._heatmapManager=new M(this),this._heatmapManager.initialize(b)):this.renderer&&this.renderer.getRendererInfo?e.some(this.renderer.rendererInfos,
function(a){return a.renderer&&"colors"in a.renderer&&"blurRadius"in a.renderer})||(this._heatmapManager=null):this._heatmapManager=null;if(a){var c=[],b=e.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],h.isDefined),d=function(a){return null!=a&&"function"!=typeof a&&a};e.forEach(b,function(a){var b=d(a.attributeField),N=d(a.attributeField2);a=d(a.attributeField3);!1!==b&&c.push(b);!1!==N&&c.push(N);!1!==a&&c.push(a)});this._rendererFields=c}else this._rendererFields=
[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._rendererFields),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments);this._trackManager&&this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||!a.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(a&&a.trackRenderer)},
_setMap:function(a){var b=this.inherited(arguments),c=this._mode,d=this;c&&c.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase());this._addHandle=this.on("graphic-node-add",function(a){a=a.graphic.attributes;(a=d._selectedFeatures[a&&a[d.objectIdField]])&&a.attr("data-selected","")});return b},_unsetMap:function(a){var b=this._mode;b&&b.suspend();this._trackManager&&(this._trackManager.destroy(),this._trackManager=null);s.disconnect(this._zoomConnect);
s.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},refresh:function(){this._needsRefresh=!1;var a=this._mode;a&&a.refresh()},hasXYFootprint:function(){return"esriGeometryMultiPatch"===this.geometryType&&"xyFootprint"===this.multipatchOption},getOutFields:function(){return e.filter(this._getOutFields(),function(a){return"*"===a||!!this._getField(a)},this)},getField:function(a){return this._getField(a,!0)},getDomain:function(a,
b){var c,d,w=b&&b.feature,f=w&&this.typeIdField&&w.attributes&&w.attributes[this.typeIdField];null!=f&&e.some(this.types,function(b){if(b.id==f){if((c=b.domains&&b.domains[a])&&"inherited"===c.type)c=this._getLayerDomain(a),d=!0;return!0}return!1},this);!d&&!c&&(c=this._getLayerDomain(a));return c},_getLayerDomain:function(a){var b;e.some(this.fields,function(c){c.name===a&&(b=c.domain);return!!b});return b},getType:function(a){var b,c=a&&this.typeIdField&&a.attributes&&a.attributes[this.typeIdField];
e.some(this.types,function(a){a.id==c&&(b=a);return!!b});return b},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(!this.loaded)return this._optEditable=a,this;var b=this._editable;this._editable=a;this._updateCaps();if(b!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var b={canCreate:!1,canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return b;
var c=a&&a.feature;a=a&&a.userId;var d=e.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],p.trim),w=-1<e.indexOf(d,"editing"),f=w&&-1<e.indexOf(d,"create"),b=w&&-1<e.indexOf(d,"update"),d=w&&-1<e.indexOf(d,"delete"),h=this.ownershipBasedAccessControlForFeatures,g=this.editFieldsInfo,k=g&&g.creatorField,g=g&&g.realm,c=(c=c&&c.attributes)&&k?c[k]:void 0,m=!!this.userIsAdmin,k=!h||m||!(!h.allowOthersToUpdate&&!h.allowUpdateToOthers),h=!h||m||!(!h.allowOthersToDelete&&!h.allowDeleteToOthers);
if(m||w&&!f&&!b&&!d)f=b=d=!0;w={canCreate:f,canUpdate:b,canDelete:d};null===c?(w.canUpdate=b&&k,w.canDelete=d&&h):""!==c&&c&&((a=a||this.getUserId())&&g&&(a=a+"@"+g),a.toLowerCase()!==c.toLowerCase()&&(w.canUpdate=b&&k,w.canDelete=d&&h));return w},getUserId:function(){var a;this.loaded&&(a=this.credential&&this.credential.userId||this.userId||"");return a},setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=a},getEditSummary:function(a,b,c){c=
h.isDefined(c)?c:(new Date).getTime();var d="";c=this.getEditInfo(a,b,c);(b=b&&b.callback||this.editSummaryCallback)&&(c=b(a,c)||"");if(p.isString(c))d=c;else{if(c){a=c.action;b=c.userId;var e=c.timeValue,f=0;a&&f++;b&&f++;h.isDefined(e)&&f++;1<f&&(d=("edit"===a?"edit":"create")+(b?"User":"")+(h.isDefined(e)?c.displayPattern:""))}d=d&&h.substitute(c,this.i18n.layers.FeatureLayer[d])}return d},getEditInfo:function(a,b,c){if(this.loaded){c=h.isDefined(c)?c:(new Date).getTime();b=b&&b.action||"last";
var d=this.editFieldsInfo,e=d&&d.creatorField,f=d&&d.creationDateField,g=d&&d.editorField,d=d&&d.editDateField,g=(a=a&&a.attributes)&&g?a[g]:void 0,d=a&&d?a[d]:null,e=this._getEditData(a&&e?a[e]:void 0,a&&f?a[f]:null,c);c=this._getEditData(g,d,c);var k;switch(b){case "creation":k=e;break;case "edit":k=c;break;case "last":k=c||e}k&&(k.action=k===c?"edit":"creation");return k}},_getEditData:function(a,b,d){var e,f,g;h.isDefined(b)&&(f=d-b,g=0>f?"Full":6E4>f?"Seconds":12E4>f?"Minute":36E5>f?"Minutes":
72E5>f?"Hour":864E5>f?"Hours":6048E5>f?"WeekDay":"Full");if(void 0!==a||g)e=e||{},e.userId=a,g&&(a=c.format,d=new Date(b),e.minutes=Math.floor(f/6E4),e.hours=Math.floor(f/36E5),e.weekDay=a(d,{datePattern:"EEEE",selector:"date"}),e.formattedDate=a(d,{selector:"date"}),e.formattedTime=a(d,{selector:"time"}),e.displayPattern=g,e.timeValue=b);return e},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},setMaxAllowableOffset:function(a){this.isEditable()||this._setMaxOffset(a,!0);return this},
getMaxAllowableOffset:function(){var a=this._quantizationParameters?this._quantizationParameters.tolerance:void 0;return null!=this._maxOffset?this._maxOffset:a},_setMaxOffset:function(a,b){if(null==a)return delete this._maxOffset,delete this._quantizationParameters,this;if(this.quantize&&this.supportsCoordinatesQuantization)"esriGeometryPolyline"===this.geometryType?this._maxOffset=a:delete this._maxOffset,this._quantizationParameters={mode:"view",originPosition:"upperLeft",tolerance:a,extent:this.fullExtent};
else{if(!this._isFractionalOffsetAllowed()||!b)a=Math.floor(a);isNaN(a)||0===a?delete this._maxOffset:this._maxOffset=a;delete this._quantizationParameters}return this},_isFractionalOffsetAllowed:function(){return null==this.version||10.1<=this.version||navigator.languages&&this._isLangWithDot(navigator.languages[0])},_isLangWithDot:function(a){a=(a=a&&a.split("-"))&&a[0]&&a[0].toLowerCase();return-1!==e.indexOf(this._langsWithDot,a)},_langsWithDot:"ar en et fr he ja ko th vi zh".split(" "),setAutoGeneralize:function(a){if(this.loaded){if(!this.isEditable()&&
this.mode!==B.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint()))(this._autoGeneralize=a)?(this._autoSnapshot&&(this._prevScale=null),this._updateMaxOffset()):this._setMaxOffset(null)}else this._optAutoGen=a;return this},setGDBVersion:function(a){if(!this._collection&&a!==this.gdbVersion&&(a||this.gdbVersion))this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=p.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),
this._map&&this.refresh()),this.onGDBVersionChange();return this},setDefinitionExpression:function(a){this._defnExpr=a;(a=this._mode)&&a.propertyChangeHandler(1);return this},getDefinitionExpression:function(){return this._defnExpr},setTimeDefinition:function(a){this._isSnapshot?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+this.id+", Layer URL \x3d "+
this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,b){this._timeOffset=a;this._timeOffsetUnits=b;var c=this._mode;c&&c.propertyChangeHandler(0);return this},setUseMapTime:function(a){this.useMapTime=a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,b,c,d){b=b||B.SELECTION_NEW;a=this._getShallowClone(a);var e=this._map,f,h=this,g=z._fixDfd(new k(z._dfdCanceller));a.outFields=this.getOutFields();
a.returnGeometry=!0;a.multipatchOption=this.multipatchOption;e&&(a.outSpatialReference=new H(e.spatialReference.toJson()));if(!this._applyQueryFilters(a,!0))return f={features:[]},this._selectHandler(f,b,c,d,g),g;if(e=this._canDoClientSideQuery(a))g._pendingDfd=m(this._doQuery(a,e)),g._pendingDfd.then(function(a){f={features:a};h._selectHandler(f,b,c,d,g)});else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,d,g,!0),g;var l=this;this._ts&&
(a._ts=(new Date).getTime());(g._pendingDfd=this._task.execute(a)).addCallbacks(function(a){l._selectHandler(a,b,c,d,g)},function(a){l._resolve([a],null,d,g,!0)})}return g},getSelectedFeatures:function(){var a=this._selectedFeatures,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},clearSelection:function(a){var b=this._selectedFeatures,c=this._mode,d;for(d in b)b.hasOwnProperty(d)&&(this._unSelectFeatureIIf(d,c),c._removeFeatureIIf(d));this._selectedFeatures={};this._isSelOnly&&c._applyTimeFilter(!0);
if(!a)this.onSelectionClear();return this},setSelectionSymbol:function(a){if(this._selectionSymbol=a){var b=this._selectedFeatures,c;for(c in b)b.hasOwnProperty(c)&&b[c].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(a){a?(this.labelingInfo=a,this._fixLabelExpr()):delete this.labelingInfo;this._collection&&(this._typesDirty=!0);this.onLabelingInfoChange()},_fixLabelExpr:function(){var a=/\[([^\[\]]+)\]/ig,b,c=this,d=function(a,b){var d=
c._getField(b,!0);return"["+(d&&d.name||b)+"]"};e.forEach(this.labelingInfo,function(c){if(b=c.labelExpression)c.labelExpression=b.replace(a,d)})},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(a,b,c,d,f,g){var h=g.assembly,k=g.dfd;this._applyNormalized(a,h&&h[0]);this._applyNormalized(b,h&&h[1]);this.onBeforeApplyEdits(a,b,c);var m={},l=this.objectIdField,h={f:"json"},n=!1;if(this._collection)g={},g.addResults=a?e.map(a,function(){n=!0;return{objectId:this._nextId++,
success:!0}},this):null,g.updateResults=b?e.map(b,function(a){n=!0;var b=a.attributes[l];m[b]=a;return{objectId:b,success:!0}},this):null,g.deleteResults=c?e.map(c,function(a){n=!0;return{objectId:a.attributes[l],success:!0}},this):null,n?this._editHandler(g,a,m,d,f,k):this._resolve([g.addResults,g.updateResults,g.deleteResults],null,d,k);else{a&&0<a.length&&(h.adds=this._convertFeaturesToJson(a,0,1),n=!0);if(b&&0<b.length){for(g=0;g<b.length;g++){var r=b[g];m[r.attributes[l]]=r}h.updates=this._convertFeaturesToJson(b,
0,0,1);n=!0}if(c&&0<c.length){b=[];for(g=0;g<c.length;g++)b.push(c[g].attributes[l]);h.deletes=b.join(",");n=!0}if(n){var O=this;return q({url:this._url.path+"/applyEdits",content:p.mixin(h,this._url.query),callbackParamName:"callback",load:function(b){O._editHandler(b,a,m,d,f,k)},error:function(a){O._resolve([a],null,f,k,!0)}},{usePost:!0})}this._resolve([],null,d,k)}},queryFeatures:function(a,b,c){return this._query("execute","onQueryFeaturesComplete",a,b,c)},queryRelatedFeatures:function(a,b,c){return this._query("executeRelationshipQuery",
"onQueryRelatedFeaturesComplete",a,b,c)},queryIds:function(a,b,c){return this._query("executeForIds","onQueryIdsComplete",a,b,c)},queryCount:function(a,b,c){return this._query("executeForCount","onQueryCountComplete",a,b,c)},queryExtent:function(a,b,c){return this._query("executeForExtent","onQueryExtentComplete",a,b,c)},queryAttachmentInfos:function(a,c,d){var f=this._url.path+"/"+a+"/attachments",g=new k(z._dfdCanceller),h=this;g._pendingDfd=q({url:f,content:p.mixin({f:"json"},this._url.query),
callbackParamName:"callback",load:function(d){d=d.attachmentInfos;var K;e.forEach(d,function(c){K=b.objectToQuery({gdbVersion:h._url.query&&h._url.query.gdbVersion,layer:h._url.query&&h._url.query.layer,token:h._getToken()});c.url=f+"/"+c.id+(K?"?"+K:"");c.objectId=a});h._resolve([d],"onQueryAttachmentInfosComplete",c,g)},error:function(a){h._resolve([a],null,d,g,!0)}});return g},addAttachment:function(a,b,c,d){return this._sendAttachment("add",a,b,c,d)},updateAttachment:function(b,c,d,e,f){d.appendChild(a.create("input",
{type:"hidden",name:"attachmentId",value:c}));return this._sendAttachment("update",b,d,e,f)},deleteAttachments:function(a,b,c,d){var f=this._url.path+"/"+a+"/deleteAttachments",g=new k(z._dfdCanceller),h=this;b={f:"json",attachmentIds:b.join(",")};g._pendingDfd=q({url:f,content:p.mixin(b,this._url.query),callbackParamName:"callback",load:p.hitch(this,function(b){b=b.deleteAttachmentResults;b=e.map(b,function(b){b=new F(b);b.attachmentId=b.objectId;b.objectId=a;return b});h._resolve([b],"onDeleteAttachmentsComplete",
c,g)}),error:function(a){h._resolve([a],null,d,g,!0)}},{usePost:!0});return g},addType:function(a){var b=this.types;if(b){if(e.some(b,function(b){return b.id==a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var c=-1;e.some(b,function(b,d){return b.id==a?(c=d,!0):!1});if(-1<c)return this._typesDirty=!0,b.splice(c,1)[0]}}},toJson:function(){var a=this._json;if(a=p.isString(a)?u.fromJson(a):p.clone(a)){var a=
a.layerDefinition?a:{layerDefinition:a},b=a.layerDefinition,c=this._collection;if(c&&this._typesDirty){b.types=e.map(this.types||[],function(a){return a.toJson()});var d=this.renderer,f=this.labelingInfo,g=b.drawingInfo;if((d||f)&&!g)g=b.drawingInfo={};g&&(d&&-1===d.declaredClass.indexOf("TemporalRenderer"))&&(g.renderer=d.toJson());f&&(g.labelingInfo=e.map(f,function(a){return a.toJson()}))}d=null;if(!c||this._fcAdded)d={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,
!0)};a.featureSet=p.mixin({},a.featureSet||{},d);a.featureSet.transform&&(f=a.featureSet.transform,delete a.featureSet.transform,d=new G(a.featureSet),d.quantize(f),a.featureSet=d.toJson());c&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);return a}},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},
onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},onLabelingInfoChange:function(){},_forceIdentity:function(a){function b(a){var c=["allowOthersToUpdate","allowOthersToDelete","allowOthersToQuery"];return a&&e.some(c,function(b){return a.hasOwnProperty(b)&&
!a[b]})}var c=this,d,f=this._url&&this._url.path;d=f&&f.toLowerCase().indexOf("/rest/services");(this.userIsAdmin||b(this.ownershipBasedAccessControlForFeatures))&&!this._getToken()&&-1<d&&l.id?(d=f.substring(0,d)+"/rest/info",q({url:d,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(function(a){if(a.owningSystemUrl)return l.id.checkSignInStatus(a.owningSystemUrl+"/sharing")}).then(function(a){if(a)return l.id.getCredential(f)}).then(function(a){a&&c._findCredential()}).always(function(){a.call(c)})):
a.call(this)},_checkMode:function(a){var b=this.geometryType,c=this.maxRecordCount;a=(a=a&&a.features&&a.features[0])&&a.attributes&&a.attributes.exceedslimit;if(this.mode===B.MODE_AUTO&&!this.isEditable()&&0===a&&(this.queryPagination||("esriGeometryPolyline"===b||"esriGeometryPolygon"===b||"esriGeometryMultipoint"===b||this.hasXYFootprint())&&c>=this.maxRecordCountForAuto||"esriGeometryPoint"===b&&c>=this.maxPointCountForAuto))this.currentMode=B.MODE_SNAPSHOT,this._mode=new J(this),this._isSnapshot=
this._autoSnapshot=!0},_queryLimit:function(){var a=this,b=new k;this._limitPromise=b.promise;setTimeout(function(){var c=new I,d=new U;d.statisticType="exceedslimit";d.maxPointCount=a.maxPointCountForAuto;d.maxRecordCount=a.maxRecordCountForAuto;d.maxVertexCount=a.maxVertexCountForAuto;d.outStatisticFieldName="exceedslimit";c.outStatistics=[d];a.queryFeatures(c).promise.then(function(a){b.resolve(a)},function(a){b.reject(a)})},0)},_updateCaps:function(){var a=this._editable,b=p.trim(this.capabilities||
""),c=e.map(b?b.split(","):[],p.trim),d=e.map(b?b.toLowerCase().split(","):[],p.trim),b=e.indexOf(d,"editing"),f,d={Create:e.indexOf(d,"create"),Update:e.indexOf(d,"update"),Delete:e.indexOf(d,"delete")};if(a&&-1===b)c.push("Editing");else if(!a&&-1<b){a=[b];for(f in d)-1<d[f]&&a.push(d[f]);a.sort();for(f=a.length-1;0<=f;f--)c.splice(a[f],1)}this.capabilities=c.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);
var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);this._toggleTime(!0);var b=this._mode,c=this._map,d=this._getRenderer();if(a.firstOccurrence){this._fixRendererFields();this._checkFields();this.clearSelection();if(this.timeInfo&&!this._trackManager&&(this._trackIdField||d&&(d.latestObservationRenderer||d.trackRenderer)))this._trackManager=new ga(this),this._trackManager.initialize(c);d&&("colors"in d&&"blurRadius"in d&&"maxPixelIntensity"in d)&&("esriGeometryPoint"==
this.geometryType&&!this._heatmapManager)&&(this._heatmapManager=new M(this),this._heatmapManager.initialize(c));if(this._autoSnapshot&&this._autoGeneralize&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint())&&!this.isEditable()&&null==this.getMaxAllowableOffset())d=this.generalizeForScale,this._calculatedScale=d=this.maxScale?this.maxScale:this.minScale?Math.min(d,this.minScale):Math.min(d,X.getScale(c,this.initialExtent)),this._calcMaxOffset=
c.extent.getWidth()/c.width/c.getScale()*d;this._zoomConnect=s.connect(c,"onZoomEnd",this,this._zoomEndHandler);this._updateMaxOffset();this._needsRefresh=!1;b&&b.startup()}else this._zoomEndHandler(),b&&b.resume()},_zoomEndHandler:function(){var a=this._map;this._updateMaxOffset();this._prevScale=a.getScale();!this.suspended&&this._needsRefresh&&this.refresh()},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&(this._autoSnapshot?(a=this.getMaxAllowableOffset(),this._setMaxOffset(this._getMaxOffsetForScale(),
!0),this._needsRefresh||(this._needsRefresh=a!=this.getMaxAllowableOffset())):this._setMaxOffset(a.extent.getWidth()/a.width,!a.extent.spatialReference.isWebMercator()))},_getMaxOffsetForScale:function(){if(this._map){var a=this._map.getScale(),b=this._calculatedScale,c=this._calcMaxOffset,d=this._prevScale;return a>=b&&(null==d||d<b)?c:a<b&&(null==d||d>=b)?null:this.getMaxAllowableOffset()}},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&this.useMapTime&&b?(this._mapTimeExtent=b.timeExtent,
this._timeConnect||(this._timeConnect=s.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,s.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(a){this._mapTimeExtent=a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=this._timeOffset,c=this._timeOffsetUnits;return a&&b&&c?a.offset(-1*b,c):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):a||b},_getTimeFilter:function(a){var b=this.getTimeDefinition(),
c;if(b&&(c=this._getTimeOverlap(b,null),!c))return[!1];if(a){if(a=c?this._getTimeOverlap(a,c):a,!a)return[!1]}else a=c;return[!0,a]},_getAttributeFilter:function(a){var b=this.getDefinitionExpression();return a?b?"("+b+") AND ("+a+")":a:b},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);a.maxAllowableOffset||(a.maxAllowableOffset=this._maxOffset);a.quantizationParameters=this._quantizationParameters;b&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||this.getOrderByFields());
if(this.timeInfo){var c=this._getTimeFilter(a.timeExtent);if(c[0])a.timeExtent=c[1];else return!1}return!0},_add:function(a){var b=this._selectionSymbol,c=a.attributes,d=this.visibilityField;b&&this._isSelOnly&&a.setSymbol(b);if(d&&c&&c.hasOwnProperty(d))a[c[d]?"show":"hide"]();return this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a){var b=[],c=this._map,d;if(!(this._isTable||!c&&!this._collection))if(!a.text&&!(a.where&&
a.where!==this.getDefinitionExpression()||a.orderByFields&&a.orderByFields.length&&(d=this.getOrderByFields()||[])&&a.orderByFields.join()!==d.join()||a.outStatistics||a.returnDistinctValues)){d=this._isSnapshot;var f=this._isSelOnly,g=a.geometry;if(g)if(!f&&a.spatialRelationship===I.SPATIAL_REL_INTERSECTS&&"extent"===g.type&&(d||c.extent.contains(g)))b.push(1);else return;if(c=a.objectIds)if(d)b.push(2);else{var g=c.length,h=this._mode,k=0,m;for(m=0;m<g;m++)h._getFeature(c[m])&&k++;if(k===g)b.push(2);
else return}if(this.timeInfo)if(a=a.timeExtent,c=this._mapTimeExtent,d)a&&b.push(3);else if(f){if(a)return}else if(c)if(-1!==e.indexOf(b,2))a&&b.push(3);else if(-1!==e.indexOf(b,1))a==c&&b.push(3);else return;else if(0<b.length)a&&b.push(3);else if(a)return;return 0<b.length?b:null}},_getAbsMid:function(a){return f.toAbsMid?f.toAbsMid(a):n.id.replace(/\/[^\/]*$/ig,"/")+a},_doQuery:function(a,b,c){var d=[],f=this.objectIdField,g=this,h=new k,m=new k,l=this.graphics;if(-1!==e.indexOf(b,1)){var n=this.spatialIndex||
this._map&&this._map.spatialIndex,q,r=a.geometry._normalize(null,!0);null==n&&ia.autoSpatialIndexing?q=(this._map||this).addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(p.hitch(this,p.partial(this._getFromIndex,r,n)),function(a){m.resolve(p.hitch(this,p.partial(this._filterByExtent,l,r)))}):n&&(q=this._getFromIndex(r,n));q?q.then(function(a){for(var b=0;b<a.length;b++)a[b].results&&(d=d.concat(a[b].results));m.resolve(d)}).otherwise(function(a){m.reject(a)}):m.resolve(this._filterByExtent(l,
r))}else m.resolve(l);m.then(function(k){d=k;if(-1!==e.indexOf(b,2)){var m=a.objectIds;d=e.filter(d,function(a){return-1<e.indexOf(m,a.attributes[f])})}-1!==e.indexOf(b,3)&&g.timeInfo&&(k=a.timeExtent,d=g._filterByTime(d,k.startTime,k.endTime).match);c&&(d=e.map(d,function(a){return a.attributes[f]},this));h.resolve(d)});return h},_getFromIndex:function(a,b){b=b||this.spatialIndex||this._map.spatialIndex;a instanceof Array||(a=[a]);var c=this.id;return t(e.map(a,function(a){return b.intersects(a,
c)}))},_filterByExtent:function(a,b){for(var c=[],d=0,e=a.length;d<e;d++){var f=a[d],g=f.geometry;g&&(this.normalization&&b.length?(b[0].intersects(g)||b[1].intersects(g))&&c.push(f):b.intersects(g)&&c.push(f))}return c},_filterByTime:function(a,b,c){var d=this._startTimeField,e=this._endTimeField,f;this._twoTimeFields||(f=d||e);var g=h.isDefined,k=[],m=[],l,n=a.length,p,q;b=b?b.getTime():-Infinity;c=c?c.getTime():Infinity;if(f)for(l=0;l<n;l++)p=a[l],q=p.attributes,d=q[f],d>=b&&d<=c?k.push(p):m.push(p);
else for(l=0;l<n;l++)p=a[l],q=p.attributes,f=q[d],q=q[e],f=g(f)?f:-Infinity,q=g(q)?q:Infinity,f>=b&&f<=c||q>=b&&q<=c||b>=f&&c<=q?k.push(p):m.push(p);return{match:k,noMatch:m}},_resolve:function(a,b,c,d,e){b&&this[b].apply(this,a);c&&c.apply(null,a);d&&z._resDfd(d,a,e)},_getShallowClone:function(a){var b=new I,c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_query:function(a,b,c,d,f){var g=this,h=this._map,l=new k(z._dfdCanceller),n=c,p,q;if("executeRelationshipQuery"!==a){var n=this._getShallowClone(c),
r=this.getOutFields();n.outFields||(n.outFields=r);n.outFields&&n.outFields.length&&(q=-1<e.indexOf(r,"*")?!1:!e.every(n.outFields,function(a){return-1<e.indexOf(r,a)}));n.returnGeometry=c.hasOwnProperty("returnGeometry")?c.returnGeometry:!c.outStatistics;n.returnGeometry&&(n.multipatchOption=this.multipatchOption);var s;h&&(c=h&&h.spatialReference,(h=n.outSpatialReference)?p=!h.equals(c):n.outSpatialReference=new H(c.toJson()));if(!this._applyQueryFilters(n,"execute"===a&&!n.outStatistics)){switch(a){case "execute":s=
new G({features:[]});break;case "executeForIds":s=[];break;case "executeForCount":s=0;break;case "executeForExtent":s={}}this._resolve([s],b,d,l);return l}if(c="executeForExtent"!==a&&!p&&!q&&this._canDoClientSideQuery(n))return l._pendingDfd=m(this._doQuery(n,c,"executeForIds"===a||"executeForCount"===a)),l._pendingDfd.then(function(c){switch(a){case "execute":s=new G;s.features=c;break;case "executeForIds":s=c;break;case "executeForCount":s=c.length}g._resolve([s],b,d,l)}),l}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+
this.invalidParams)],null,f,l,!0),l;this._ts&&(n._ts=(new Date).getTime());(l._pendingDfd=this._task[a](n)).addCallbacks(function(c){var e=!!n.outStatistics||p||q;if("execute"===a||"executeRelationshipQuery"===a){var f,h;if("execute"===a){f=c.features;h=f.length;for(h-=1;0<=h;h--)if(f[h]._layer=g,!e&&!g._isTable){var k=g._mode._getFeature(f[h].attributes[g.objectIdField]);k&&f.splice(h,1,k)}}else for(k in c)if(c.hasOwnProperty(k)){f=c[k].features;h=f.length;for(h-=1;0<=h;h--)f[h]._layer=g}}g._resolve([c],
b,d,l)},function(a){g._resolve([a],null,f,l,!0)});return l},_convertFeaturesToJson:function(a,b,c,d){var f=[],g=this._selectionSymbol,h=this.visibilityField,k,l=this.objectIdField;if(this.loaded&&(c||d))k=e.filter(this.fields,function(a){return!1===a.editable&&(!d||a.name!==l)});for(c=0;c<a.length;c++){var m=a[c],n={},q=m.geometry,r=m.attributes,s=m.symbol;if(q&&(!d||!this.loaded||this.allowGeometryUpdates))n.geometry=q.toJson();h?(n.attributes=r=p.mixin({},r),r[h]=m.visible?1:0):r&&(n.attributes=
p.mixin({},r));n.attributes&&(k&&k.length)&&e.forEach(k,function(a){delete n.attributes[a.name]});s&&s!==g&&(n.symbol=s.toJson());f.push(n)}return b?f:u.toJson(f)},_selectHandler:function(a,b,c,d,e){var f;d=B;switch(b){case d.SELECTION_NEW:this.clearSelection(!0);f=!0;break;case d.SELECTION_ADD:f=!0;break;case d.SELECTION_SUBTRACT:f=!1}d=a.features;var g=this._mode,h=[],k=this.objectIdField,l,m;if(f)for(f=0;f<d.length;f++)l=d[f],m=l.attributes[k],l=g._addFeatureIIf(m,l),h.push(l),this._selectFeatureIIf(m,
l,g);else for(f=0;f<d.length;f++)l=d[f],m=l.attributes[k],this._unSelectFeatureIIf(m,g),m=g._removeFeatureIIf(m),h.push(m||l);this._isSelOnly&&g._applyTimeFilter(!0);this._resolve([h,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",c,e);if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,c){var d=this._selectedFeatures,e=d[a];e||(c._incRefCount(a),d[a]=b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return e||
b},_unSelectFeatureIIf:function(a,b){var c=this._selectedFeatures[a];c&&(b._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(c),c.attr("data-selected")));return c},_isSelected:function(a){},_setSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,
this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields).concat(this.dataAttributes),a=e.filter(a,function(a,b,c){return!!a&&e.indexOf(c,a)===b}),b=p.clone(this._outFields);if(b){if(-1!==e.indexOf(b,"*"))return b;e.forEach(a,function(a){-1===e.indexOf(b,a)&&b.push(a)});return b}return a},_checkFields:function(a){var b=a||this._getOutFields();e.forEach(b,function(a){"*"!==a&&(this._getField(a)||console.debug("esri.layers.FeatureLayer: "+h.substitute({url:this.url,
field:a},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);!a&&(!this._isTable&&!this._fserver&&!this._collection&&!this._isStream)&&(e.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+h.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]")))},
_fixFieldCase:function(a,b,c){var d=a&&a[b],e;if(d&&!p.isFunction(d)){if(e=!this._getField(d)&&this._getField(d,!0))d=a[b]=e.name;c&&c.push(d)}return d},_fixRendererFields:function(){var a=this.renderer;this._orderBy=null;if(a&&0<this.fields.length){var b=[],c,a=e.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],h.isDefined),d=[].concat(a);e.forEach(a,function(a){e.forEach(a.rendererInfos,function(a){a.renderer&&d.push(a.renderer)})});e.forEach(d,function(a){this._fixFieldCase(a,
"attributeField",b);this._fixFieldCase(a,"attributeField2",b);this._fixFieldCase(a,"attributeField3",b);this._fixFieldCase(a.rotationInfo,"field",b);if((c=this._fixFieldCase(a.sizeInfo,"field",b))&&!this._orderBy)this._orderBy=[c+" DESC"];this._fixFieldCase(a.sizeInfo,"normalizationField",b);this._fixFieldCase(a.colorInfo,"field",b);this._fixFieldCase(a.colorInfo,"normalizationField",b);this._fixFieldCase(a.field,"field",b);this._fixFieldCase(a.opacityInfo,"field",b);this._fixFieldCase(a.opacityInfo,
"normalizationField",b);e.forEach(a.visualVariables,function(a){c=this._fixFieldCase(a,"field",b);"sizeInfo"===a.type&&(c&&!this._orderBy)&&(this._orderBy=[c+" DESC"]);this._fixFieldCase(a,"normalizationField",b)},this);if(!this._orderBy&&a.addBreak&&!p.isFunction(a.attributeField)&&(a.backgroundFillSymbol||this._hasSizeDiff(a)))this._orderBy=[a.attributeField+" DESC"]},this);this._rendererFields=e.filter(b,h.isDefined)}},_hasSizeDiff:function(a){var b=Number.MAX_VALUE,c=-Number.MAX_VALUE,d,f;e.forEach(a.infos,
function(a){if(f=a.symbol){d=0;switch(f.type){case "simplemarkersymbol":d=f.size;break;case "picturemarkersymbol":d=(f.width+f.height)/2;break;case "simplelinesymbol":case "cartographiclinesymbol":d=f.width;break;case "simplefillsymbol":case "picturefillsymbol":d=f.outline&&f.outline.width}d&&(b=Math.min(b,d),c=Math.max(c,d))}});return b!==Number.MAX_VALUE&&c!==-Number.MAX_VALUE&&1<Math.abs(c-b)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&
a?e.filter(a,function(a){a=a.split(" ")[0];return!!this._getField(a,!0)},this):null},_getField:function(a,b){var c=this.fields;if(!c||0===c.length)return null;var d;b&&(a=a.toLowerCase());e.some(c,function(c){var e=!1;(e=b?c&&c.name.toLowerCase()===a?!0:!1:c&&c.name===a?!0:!1)&&(d=c);return e});return d},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:e.map(e.filter(this.fields,function(a){return!!(a&&"esriFieldTypeDate"===a.type)}),function(a){return a.name})});return this._dtOpts},
_applyNormalized:function(a,b){a&&b&&e.forEach(a,function(a,c){a&&b[c]&&a.setGeometry(b[c])})},_editHandler:function(a,b,c,d,f,g){f=a.addResults;var h=a.updateResults;a=a.deleteResults;var k,l,m,n,q=this.objectIdField,r=this._mode,s=this._isTable;k=this.editFieldsInfo;var t=this.getOutFields()||[],u=k&&k.creatorField,v=k&&k.creationDateField,x=k&&k.editorField,z=k&&k.editDateField;k=k&&k.realm;-1===e.indexOf(t,"*")&&(u&&-1===e.indexOf(t,u)&&(u=null),v&&-1===e.indexOf(t,v)&&(v=null),x&&-1===e.indexOf(t,
x)&&(x=null),z&&-1===e.indexOf(t,z)&&(z=null));var t=v||z?(new Date).getTime():null,A=u||x?this.getUserId():void 0;A&&k&&(A=A+"@"+k);if(f)for(k=0;k<f.length;k++)f[k]=new F(f[k]),s||(l=f[k],l.success&&(l=l.objectId,m=b[k],(n=m._graphicsLayer)&&n!==this&&n.remove(m),n=m.attributes||{},n[q]=l,u&&(n[u]=A),x&&(n[x]=A),v&&(n[v]=t),z&&(n[z]=t),m.setAttributes(n),r._init&&r.drawFeature(m)));if(h)for(k=0;k<h.length;k++)if(h[k]=new F(h[k]),!s&&(l=h[k],l.success)){l=l.objectId;m=c[l];if(b=r._getFeature(l))b.geometry!==
m.geometry&&m.geometry&&b.setGeometry(V.fromJson(m.geometry.toJson())),b.attributes!==m.attributes&&m.attributes&&b.setAttributes(p.mixin(b.attributes,m.attributes)),this._repaint(b,l);m=b||m;n=m.attributes||{};x&&(n[x]=A);z&&(n[z]=t);m.setAttributes(n)}if(a){c=[];for(k=0;k<a.length;k++)if(a[k]=new F(a[k]),!s&&(l=a[k],l.success&&(l=l.objectId,m=r._getFeature(l))))this._unSelectFeatureIIf(l,r)&&c.push(m),m._count=0,r._removeFeatureIIf(l);if(0<c.length)this.onSelectionComplete(c,B.SELECTION_SUBTRACT)}this._resolve([f,
h,a],"onEditsComplete",d,g)},_sendAttachment:function(a,b,c,d,e){var f=this;return q({url:this._url.path+"/"+b+"/"+("add"===a?"addAttachment":"updateAttachment"),form:c,content:p.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(c){var e="add"===a?"onAddAttachmentComplete":"onUpdateAttachmentComplete";c=new F(c["add"===a?"addAttachmentResult":"updateAttachmentResult"]);c.attachmentId=c.objectId;c.objectId=b;f._resolve([c],
e,d);return c}).addErrback(function(a){f._resolve([a],null,e,null,!0)})},_repaint:function(a,b,c){b=h.isDefined(b)?b:a.attributes[this.objectIdField];(!(b in this._selectedFeatures)||!this._selectionSymbol)&&a.setSymbol(a.symbol,c)},_getKind:function(a){var b=this._trackManager;return b?b.isLatestObservation(a)?1:0:0}});p.mixin(B,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",
POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});W._createWrappers(B);d("extend-esri")&&p.setObject("layers.FeatureLayer",B,l);return B});